---
title: "annotation"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```


Load in Seurat object containing integrated and normalized data from 8 donors
```{r loading data}
donors.integrated=readRDS("seurat-integrated.rds")
```


```{r defining clusters}
donors.integrated <- FindNeighbors(donors.integrated, dims = 1:10) # generates KNN graph
donors.integrated <- FindClusters(donors.integrated, resolution = 0.5) #louvain

#clusters can be accessed using Idents()
#cluster labels accessed via: levels(object)
```


```{r initial Cluster labeling on umap}
jpeg("seurat-cluster_number-umap.jpeg")
DimPlot(donors.integrated, reduction = "umap", group.by ="seurat_clusters" )
dev.off()
```



consider running this in parallel
```{r biomarkers for clusters }
#to run finallmarkers in parallel
#plan("multiprocess", workers = detectCores())

#find markers for all clusters
integrated.markers <- FindAllMarkers(donors.integrated, only.pos = FALSE, min.pct = 0.25, logfc.threshold = 0.25)

#save
fwrite(integrated.markers, file="seurat-all_markers.txt")
#remove mitochondrial genes
integrated.markers=subset(integrated.markers,
                          !grepl("MT-",row.names(integrated.markers)))



topmarker=integrated.markers %>% group_by(cluster) %>% top_n(n = 5, wt = avg_logFC)
```


```{r visualizing clusters with markers}
DimPlot(donors.integrated, reduction = "umap",group.by="donor")
DimPlot(donors.integrated, reduction = "umap",group.by="seurat_clusters")

#histogram for each cluster
RidgePlot(donors.integrated,features=topmarker$gene[6:10])

#dotplot: expression  + %age expressing 
DotPlot(donors.integrated,features=topmarker$gene) + RotatedAxis()

#Featureplot  #3d map with single gene heatmap


#heatmap with cluster abels and selected genes
DoHeatmap(donors.integrated, features = topmarker, size = 3)
```



find markers for all clusters. not all clusters may have genes that meet the threshold criteria (logFC & %age of cell expression)
```{r find positive markers}
markers <- FindAllMarkers(donors.integrated, only.pos = TRUE, min.pct = 0.25, logfc.threshold = 1)
```


## Cluster annotation using markers

files downloaded from CellMarker database
```{r loading cellmarker db markers}
human_markers=read.table("Human_cell_markers.txt", sep='\t',header = TRUE, stringsAsFactors = F)
single_markers=read.table("Single_cell_markers.txt", sep='\t',header = TRUE, stringsAsFactors = F)
#markers=read.table("cluster_markers.txt") #load saved marker data if needed
```


```{r checking for occurrence of db markers in biomarker genes}
#matching based on human cell markers
hmatch=merge(markers, human_markers[,c("tissueType","cellName","geneSymbol")],by.x="gene",by.y="geneSymbol") 

```
cluster labels:
0) NES neural progenitor cell /cancer stem cell 
1) B cell (cd74), neural cell, schwann cell?
2) eosinophil (cd9) schwann cell, astrocyte
3) B cell (cd74)
4) B cell ; cd74/gfap
5) macrophage (cd14/ cd68/cxcr4/cd163) with socx2/9 expression?
6) b cell cd74/gfap
7) cd24/ncam/cd9 ; neurons ncam=embryonic cells; cd24 (diff neuroblasts)
8) glul ; associated with liver carcinoma
9) sox2, nes, ncam1, thy1, cd24, abcg2 cancer; also has tissuetype: embryo
10) blood, thy1, cd9
11)



## Cluster annotation using Gene set ORA

You may need to map symbols from to entrez id for goana
```{r mapping symbols to entrez for goana}
require(org.Hs.eg.db)
#keytypes(org.Hs.eg.db) #prints fields available for matching
#keys: enter list of genes in the format specified in "keytype"
#column: returned column field
entrez=mapIds(org.Hs.eg.db,keys= markers$gene, keytype="SYMBOL", column=("ENTREZID"))

#save symbols in new column
markers$entrez=entrez


# rank by number of cells assigned to each cluster
ordered_clust=markers %>% group_by(cluster) %>% count %>% arrange(desc(n))



```

generate a list containing enriched gene sets for each cluster
```{r goana on each cluster}
require(limma)
require(GO.db)

go_ls=list()

for (i in 1:nrow(ordered_clust)){
  #goana on each row (aka cell cluster)

#subset cluster markers for total markers table  
c_markers=markers[(markers$cluster==ordered_clust$cluster[i]) & (markers$p_val_adj<=.05), ]

go.out <- goana(unique(c_markers$entrez[!is.na(c_markers$entrez)]), species="Hs",  universe=NULL)

#focus on biological processes:BP
#u can also limit size of gene set with column: N
go.useful <- go.out[go.out$Ont=="BP" &go.out$P.DE<0.1,]

#order by pvalue
go.out <- go.out[order(go.out$P.DE),] 

#names the list with the cluster number
go_ls[[ordered_clust$cluster[i]]]=go.useful

print(paste("GO on cluster:", ordered_clust$cluster[i]))
}

```

```{r Viewing enriched gene sets}
View(head(go_ls[[10]],20))
saveRDS(go_ls,"enriched_gene_sets_by_cluster.rds")
```
cluster 1: immune response
cluster 4: also immune response
cluster 5: immune response
cluster 6: ?
cluster 9: ?
cluster 10: ?




```{r checking for sc CM in biomarker genes}
biomarkers= markers[,c("cluster","gene")] #keep just the clusterid and genenames

bio_list=ls()

for (cluster in unique(biomarkers$cluster)){
  #print(cluster)
  
  #generate list of genes associated with each cluster
  cluster_gene_list= biomarkers[biomarkers$cluster==cluster, "gene"]
  
bio_list[toString(cluster)]= list(cluster_gene_list)

  
}
bio_list=lapply(bio_list,unlist)

#for each row there is a list of markers, which we will unpack here as ref_list
ref_list=strsplit(single_markers$geneSymbol,split = ", ")

lapply(bio_list, function(x) temp %in% x ) 


id=data.frame()
for (row in 1:nrow(biomarkers)){
  mark=biomarkers$gene[row]
  cluster=biomarkers$cluster[row]
  
  rowid= which(unlist(lapply(ref_short, function(x) mark %in% x)))
  if(length(rowid)) #if there are matching rows
     {
    
    print('included')
    
    #return cellname, tissuetype, marker
    newrow=c("name"=mark,"cluster"=cluster,single_markers[rowid,c("cellName","tissueType")])
    
    id=rbind(id, data.frame(newrow))
  }
}


  
 

```


```{r}
panglao=read.csv("panglao_output_top1gene.tsv",sep="\t")
```















## Alternative to CellMarker database
Use this package to access Cellmarker and Panglao db

https://cran.r-project.org/web/packages/scMappR/scMappR.pdf
```{r scmappr}
#GSVA dependency may need to be installed separately
require(scMappR)


internal <- tissue_scMappR_custom(genes,Signature,output_directory = "scMappR_Test_custom", toSave = TRUE)
```

