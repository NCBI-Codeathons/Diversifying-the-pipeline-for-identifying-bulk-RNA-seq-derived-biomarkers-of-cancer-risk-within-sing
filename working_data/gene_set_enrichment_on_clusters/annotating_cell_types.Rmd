---
title: "annotation"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

# Assignment using gene sets

```{r}
donors.integrated=readRDS("seurat-integrated.rds")

```



```{r}
markers.mam <- findMarkers(donors.integrated, sce.mam$cluster, direction="up", lfc=1)

#find markers for all clusters
markers <- FindAllMarkers(donors.integrated, only.pos = TRUE, min.pct = 0.25, logfc.threshold = 1)

c1=markers[markers$cluster==1 & markers$p_val_adj<=.05]

```

You may need to map symbols from to entrez id for goana

```{r mapping symbols to entrez for goana}
require(org.Hs.eg.db)
#keytypes(org.Hs.eg.db) #prints fields available for matching

#keys: enter list of genes in the format specified in "keytype"
#column: returned column field
entrez=mapIds(org.Hs.eg.db,keys= markers$gene, keytype="SYMBOL", column=("ENTREZID"))
markers$entrez=entrez


# number of cells in each cluster
ordered_clust=markers %>% group_by(cluster) %>% count %>% arrange(desc(n))



```

```{r goana on 5 largest cell pops}
#map symbols to entrez id for goana using DBi annotations
require(limma)
require(GO.db)

go_ls=list()

for (i in 1:dim(ordered_clust[1])){

#markers$ez=ent_symb$entrez
c_markers=markers[(markers$cluster==ordered_clust$cluster[i]) & (markers$p_val_adj<=.05), ]

go.out <- goana(unique(c_markers$ez[!is.na(c_markers$ez)]), species="Hs",  universe=NULL)

go.out <- go.out[order(go.out$P.DE),]
#N: number of genes in gene set
go.useful <- go.out[go.out$Ont=="BP" & go.out$N <= 200,]

#names the list with the cluster number
go_ls[[ordered_clust$cluster[i]]]=go.useful

print(paste("GO on cluster:", ordered_clust$cluster[i]))
}

```

clusters 4,6,7,10,12
```{r examine gene sets in each cluster}
head(go_ls[[4]])

```


```{r}
```


```{r}
```


```{r}
```

